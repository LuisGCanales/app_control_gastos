<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de Gastos</title>

  <!-- Estilos y configuración -->
  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />
  <meta name="theme-color" content="#4CAF50" />
</head>
<body>

  <!-- === Vista Principal === -->
  <main class="container" id="vista-principal">
    <h1>Control de Gastos<sup class="supscript">V56.21</sup></h1>

    <!-- Formulario de nuevo gasto -->
    <form id="gasto-form" autocomplete="off">
      <input type="text" id="concepto" list="sugerencias" placeholder="Concepto" required autocomplete="on" inputmode="text"/>
      <datalist id="sugerencias"></datalist>

      <input type="number" id="monto" placeholder="Monto" step="0.01" required />
      
      <select id="medio-pago" required>
        <option value="">Selecciona medio...</option>
      </select>

      <textarea id="nota-gasto" rows="2" placeholder="Agrega una nota (opcional)"></textarea>

      <div class="switches switches--row">
        <div class="checkbox-wrapper-17">
          <input type="checkbox" id="activar-fecha" />
          <label for="activar-fecha" title="Usar fecha personalizada"></label>
          <span class="switch-label">Fecha personalizada</span>
        </div>

        <div class="checkbox-wrapper-17">
          <input type="checkbox" id="compartido" />
          <label for="compartido" title="Compartido con alguien más"></label>
          <span class="switch-label">Compartido</span>
        </div>
      </div>

      <input type="date" id="fecha-personalizada" style="display: none;" />

      <button type="submit">Agregar Gasto</button>
    </form>

    <!-- Vista de barras apiladas con resumen de gastos  -->
    <section id="resumen" style="display: block;">
      <div id="contenedor-resumen-barras" style="display: flex; justify-content: center; margin-top: 2em; width=100%;">
        <canvas id="grafica-resumen-barras" height="350"></canvas>
      </div>
    </section>

    <!-- Acciones -->
    <div style="margin-top: 1em;">
      <button type="button" onclick="mostrarConfiguracion()">⚙️ Configuración</button>
      <button type="button" onclick="mostrarTabla()">Ver todos los gastos</button>
      <button type="button" onclick="mostrarFijosPendientes()">💡 Gastos Fijos</button>
      <button type="button" onclick="mostrarVistaLiquidez()">💰 Liquidez</button>
    </div>
  </main>

  <!-- === Vista Configuración === -->
  <section class="container" id="vista-configuracion" style="display: none;">
    <h2>Configuración de Límites</h2>
    <form id="config-form">
      <label>Límite diario: <input type="number" id="limite-dia" step="0.01" required /></label>
      <label>Límite semanal: <input type="number" id="limite-semana" step="0.01" required /></label>
      <label>Límite mensual: <input type="number" id="limite-mes" step="0.01" required /></label>
      <label>Límite mensual compartido: <input type="number" id="limite-compartido" step="0.01" required /></label>
      <label>Límite mensual TDC: <input type="number" id="limite-tdc" required /></label>
      <label>Día inicio de semana (0=D, 1=L...): <input type="number" id="inicio-semana" min="0" max="6" required /></label>
      <label>Día inicio de mes: <input type="number" id="inicio-mes" min="1" max="31" required /></label>
      <label>Día inicio TDC: <input type="number" id="inicio-tdc" min="1" max="31" required /></label>
      <label>Día inicio Compartido: <input type="number" id="inicio-compartido" min="1" max="31" required /></label>
      <div style="margin-top: 1em;">
        <button type="button" onclick="actualizarLimitesDesdeLiquidezConFeedback()">
          📊 Calcular límites dinámicos
        </button>
        <span id="limites-feedback" style="margin-left: 1em; color: #80d4aa;"></span>
      </div>
      <button type="button" onclick="mostrarVistaDistribucionSemanal()">📆 Distribución Semanal</button>
      <button type="submit">Guardar Límites</button>
    </form>
    <button type="button" onclick="volverAPrincipal()">Volver</button>
  </section>

  <!-- === Vista Distribución Semanal === -->
  <section class="container" id="vista-distribucion-semanal" style="display: none;">
    <h2>Distribución Semanal del Gasto</h2>

    <div id="limite-semanal-actual" style="text-align: center; font-size: 0.9em; color: #ccc; margin-bottom: 1em;"></div>
  
    <!-- Distribución original -->
    <h3>Distribución Original</h3>
    <canvas id="grafica-dist-original" height="220" style="margin:16px 0;"></canvas>

    <!-- Distribución ajustada -->
    <h3 style="margin-top: 2em;">Distribución Ajustada (días restantes)</h3>
    <canvas id="grafica-dist-ajustada" height="220" style="margin:16px 0;"></canvas>

    <button type="button" onclick="mostrarEditorDistribucion()">✏️ Editar proporciones</button>
    <button type="button" onclick="cerrrarVistaDistribucionSemanal()">Volver</button>
  </section>

  <!-- Modal edición proporciones -->
  <section class="container" id="modal-editar-distribucion" style="display: none;">
    <h2>Editar Proporciones Semanales</h2>
    <form id="form-editar-distribucion">
      <table style="width: 100%; margin-bottom: 1em;">
        <thead><tr><th>Día</th><th>Proporción (%)</th></tr></thead>
        <tbody id="tabla-form-distribucion"></tbody>
      </table>
      <button type="submit">💾 Guardar cambios</button>
      <button type="button" onclick="cerrarEdicionDistribucion()">Cancelar</button>
      <div id="distribucion-feedback" style="color: #ff8080; text-align: center; margin-bottom: 1em;"></div>
    </form>
  </section>

  <!-- === Vista Tabla de Gastos === -->
  <section class="container" id="vista-tabla" style="display: none;">
    <h2>Todos los Gastos</h2>
    <div class="checkbox-wrapper-17 mini-switch" style="margin-bottom: 1em;">
      <input type="checkbox" id="switch-tabla-periodo-actual" checked />
      <label for="switch-tabla-periodo-actual" title="Alternar entre histórico y periodo actual"></label>
      <span class="switch-label" id="switch-label-tabla">
        Histórico / <s>Periodo actual</s>
      </span>
    </div>
    <table id="tabla-gastos">
      <thead>
        <tr><th>Concepto</th><th>Monto</th><th>Medio</th><th>C.</th><th>F.</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>  

    <!-- Filtros -->
    <div id="filtros-gastos" style="margin-top: 2em;">
      <label>Filtrar por fecha: <input type="date" id="filtro-fecha" /></label>

      <!-- Fila con 3 switches en línea -->
      <div class="switches switches--row">
        <div class="checkbox-wrapper-17">
          <input type="checkbox" id="filtro-fijos"/>
          <label for="filtro-fijos" title="Mostrar fijos"></label>
          <span class="switch-label">Fijos</span>
        </div>

        <div class="checkbox-wrapper-17">
          <input type="checkbox" id="filtro-variables" checked />
          <label for="filtro-variables" title="Mostrar variables"></label>
          <span class="switch-label">Variables</span>
        </div>

        <div class="checkbox-wrapper-17">
          <input type="checkbox" id="filtro-solo-compartido" />
          <label for="filtro-solo-compartido" title="Solo compartidos"></label>
          <span class="switch-label">Solo compartido</span>
        </div>
      </div>

      <!-- Línea aparte para el select de Medio -->
      <div class="filtro-medio-linea">
        <label for="filtro-medio">Medio:</label>
        <select id="filtro-medio">
          <option value="">Todos</option>
        </select>
      </div>
      <button id="limpiar-filtros" style="margin-top: 1em;">Limpiar filtros</button>
    </div>
    <button id="exportar-csv">💾 Exportar CSV</button>
    <label for="importar-csv" class="importar-label">Importar CSV
      <input type="file" id="importar-csv" accept="text/*,.csv,.txt" style="display: none;" />
    </label>
    <button type="button" onclick="mostrarVistaGraficas()">📈 Ver gráficas</button>
    <button type="button" onclick="volverAPrincipal()">Volver</button>
  </section>

  <!-- === Modal Edición de Gasto === -->
  <section class="container" id="modal-edicion" style="display: none;">
    <h2>Editar Gasto</h2>
    <form id="form-editar">
      <label>Concepto: <input type="text" id="editar-concepto" required /></label>
      <label>Monto: <input type="number" id="editar-monto" step="0.01" required /></label>
      <div class="checkboxes-inline">
        <select id="editar-medio" required>
          <option value="">Selecciona medio...</option>
        </select>
        <label><input type="checkbox" id="editar-compartido" class="checkbox-minimal" />Compartido</label>
        <label><input type="checkbox" id="editar-fijo" class="checkbox-minimal" />Fijo</label>
      </div>
      <label>Fecha: <input type="date" id="editar-fecha" required /></label>
      <div class="form-group">
        <label for="editar-nota">Notas: </label>
        <textarea id="editar-nota" rows="2" placeholder="Agrega una nota"></textarea>
      </div>
      <button type="submit">Guardar cambios</button>
      <button type="button" id="btn-eliminar-gasto" style="margin-top: 1em; background-color: #802020;">🗑 Eliminar</button>
      <button type="button" onclick="cerrarFormularioEdicion()">Cancelar</button>
    </form>
  </section>


  <!-- === Vista de Gastos Fijos Pendientes === -->
  <section class="container" id="vista-fijos-pendientes" style="display: none;">
    <h2>Gastos Fijos</h2>

    <form id="form-fijos-pendientes">
      <label>Concepto: <input type="text" id="nuevo-fijo-concepto" required /></label>
      <label>Monto: <input type="number" id="nuevo-fijo-monto" step="0.01" required /></label>
      <label>Fecha límite: <input type="date" id="nuevo-fijo-fecha" required /></label>
      <label for="nota-fijo">Nota (opcional):</label>
      <textarea id="nota-fijo" rows="2" placeholder="Agrega una nota"></textarea>
      <button type="submit">Agregar</button>
      <div id="resumen-fijos" class="resumen-fijos"></div>
    </form>
    <table id="tabla-fijos-pendientes" style="margin-top: 2em;">
      <thead>
        <tr><th>Concepto</th><th>Monto</th><th>St.</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="switches filtros-switches" style="margin-top: 1em;">
      <div class="checkbox-wrapper-17">
        <input type="checkbox" id="filtro-fijo-pendiente" checked />
        <label for="filtro-fijo-pendiente" title="Mostrar pendientes"></label>
        <span class="switch-label">Pendientes</span>
      </div>
      <div class="checkbox-wrapper-17">
        <input type="checkbox" id="filtro-fijo-pagado" checked />
        <label for="filtro-fijo-pagado" title="Mostrar pagados"></label>
        <span class="switch-label">Pagados</span>
      </div>
      <div class="checkbox-wrapper-17">
        <input type="checkbox" id="filtro-fijo-pospuesto"/>
        <label for="filtro-fijo-pospuesto" title="Mostrar pospuestos"></label>
        <span class="switch-label">Pospuestos</span>
      </div>
    </div>
    <div class="acciones-secundarias">
      <button onclick="exportarFijosCSV()">💾 Exportar CSV</button>
      <label class="importar-label">
        Importar CSV
        <input type="file" accept="text/*,.csv,.txt" style="display: none;" onchange="importarFijosCSV(event)" />
      </label>
    </div>
    <button type="button" onclick="volverAPrincipal()">Volver</button>
  </section>


  <!-- Modal de edición de gasto fijo pendiente -->
  <section class="container" id="modal-edicion-fijo" style="display: none;">
    <h2>Editar Gasto Fijo</h2>
    <form id="form-editar-fijo">
      <label>Concepto: <input type="text" id="editar-fijo-concepto" required /></label>
      <label>Monto: <input type="number" id="editar-fijo-monto" step="0.01" required /></label>
      <label>Fecha límite: <input type="date" id="editar-fijo-fecha" required /></label>
      <label for="editar-fijo-nota">Nota: </label>
      <textarea id="editar-fijo-nota" rows="2" placeholder="Agrega una nota (opcional)"></textarea>
      <button type="submit">Guardar cambios</button>
      <div style="display: flex; gap: 1em; justify-content: space-between; margin-top: 1em;">
        <button type="button" id="btn-pagar-fijo" style="background-color: #1c5530;">✅ Pagar</button>
        <button type="button" id="btn-posponer-fijo" style="background-color: #6e4f1c;">⏳ Posponer</button>
          <button type="button" id="btn-reactivar-fijo" style="background-color: #3a5c8c; display: none;">🔁 Reactivar</button>
      </div>
      <button type="button" id="btn-eliminar-fijo" style="margin-top: 1em; background-color: #802020;">🗑 Eliminar</button>
      <button type="button" onclick="cerrarFormularioEdicionFijo()">Cancelar</button>
    </form>
  </section>

  <section id="modal-pago-fijo" class="container" style="display: none;">
    <form id="form-pago-fijo">
      <h2>Registrar pago de gasto fijo</h2>

      <label>Concepto:
        <input type="text" id="pago-fijo-concepto" required />
      </label>

      <label>Monto:
        <input type="number" id="pago-fijo-monto" step="0.01" required />
      </label>

      <div class="checkboxes">
        <select id="medio-pago-fijo" required>
          <option value="">Selecciona medio...</option>
        </select>
        <label><input type="checkbox" id="pago-fijo-compartido" class="checkbox-minimal"/> Compartido</label>
      </div>

      <label class="custom-fecha-label">
        <input type="checkbox" id="pago-fijo-activar-fecha" class="checkbox-minimal"/>Fecha personalizada
      </label>
      <input type="date" id="pago-fijo-fecha-personalizada" />
      
      <div class="form-group">
        <label for="pago-fijo-nota">Notas: </label>
        <textarea id="pago-fijo-nota" rows="2" placeholder="Agrega una nota"></textarea>
      </div>
      <div class="acciones-modal">
        <button type="submit">Agregar pago</button>
        <button type="button" onclick="cerrarModalPagoFijo()">Cancelar</button>
      </div>
    </form>
  </section>

  <!-- Vista de gráficas de gastos variables -->
  <section class="container" id="vista-graficas" style="display: none; padding: 5em">
    <h2>Gastos variables diarios</h2>
    <div style="display: flex; justify-content: center; margin-bottom: -0.5em; margin-top: -0.5em;">
      <div class="checkbox-wrapper-17 mini-switch" style="margin-bottom: 0em; margin-top: -1em; display: flex; flex-direction: row; align-items: center;">
        <input type="checkbox" id="switch-periodo-actual" />
        <label for="switch-periodo-actual" title="Alternar entre histórico y periodo actual"></label>
        <span class="switch-label">
          <span id="label-historico">Histórico</span> /
          <span id="label-periodo">Periodo actual</span>
        </span>
      </div>
    </div>
    <canvas id="grafica-gastos-diarios"></canvas>
    <button type="button" onclick="cerrarVistaGraficas()">Volver</button>
  </section>

  <div id="tooltip-nota" class="tooltip-nota" style="display: none;"></div>

  <!-- Vista de liquidez -->
  <section class="container" id="vista-liquidez" style="display: none;">
    <h2>Liquidez</h2>
    <div id="total-liquidez" style="margin-top: 1em; font-weight: bold; text-align: center;"></div>
    <canvas id="grafica-liquidez" style="margin-top: 2em;" height="350"></canvas>
    <div style="margin-bottom: 1em; text-align: center;">
      <button onclick="abrirModalLiquidez()">Editar Categorías</button>
    </div>
    <button onclick="volverAPrincipal()">Volver</button>
  </section>

  <!-- Modal de edición de liquidez -->
  <section class="container" id="modal-liquidez" style="display: none;">
    <h2>Editar Liquidez</h2>

    <form id="form-liquidez">
      <label>Categoría:
        <input type="text" id="nueva-categoria" required placeholder="Ej. Efectivo, BBVA" />
      </label>
      <label>Monto actual:
        <input type="number" id="monto-categoria" step="0.01" required />
      </label>
      <button type="submit">Guardar</button>
    </form>

    <table id="tabla-liquidez" class="tabla-liquidez">
      <thead>
        <tr> 
          <th class="categoria-header">Categoría</th>
          <th class="monto-header">Monto</th>
          <th class="acciones-header"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="cerrarModalLiquidez()">Cerrar</button>
  </section>


  <section class="container" id="modal-edicion-liquidez" style="display: none;">
    <h2>Editar Categoría de Liquidez</h2>
    <form id="form-editar-liquidez">
      <label>Categoría: <input type="text" id="editar-liquidez-categoria" readonly /></label>
      <label>Monto: <input type="number" id="editar-liquidez-monto" step="0.01" required /></label>
      <button type="submit">Guardar cambios</button>
      <button type="button" id="btn-eliminar-liquidez" style="margin-top: 1em; background-color: #802020;">🗑 Eliminar</button>
      <button type="button" onclick="cerrarModalEdicionLiquidez()">Volver</button>
    </form>
  </section>

  <!-- Modal de eliminación manual de gastos en localStorage no presentes en importación nueva -->
  <section class="container" id="modal-eliminar-sobrantes" style="display: none;">
    <h2>Gastos no presentes en el archivo importado</h2>
    <form id="form-eliminar-sobrantes">
      <table style="width: 100%; margin-bottom: 1em;">
        <thead>
          <tr>
            <th><input type="checkbox" id="check-todos-sobrantes" /></th>
            <th>Fecha</th>
            <th>Concepto</th>
            <th>Monto</th>
            <th>Medio</th>
            <th>C.</th>
            <th>F.</th>
          </tr>
        </thead>
        <tbody id="tabla-sobrantes"></tbody>
      </table>
      <button type="submit">🗑 Eliminar seleccionados</button>
      <button type="button" onclick="cerrarModalSobrantes()">Cancelar</button>
    </form>
  </section>


  <!-- Scripts -->
  <script src="app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script>
    Chart.register(window['chartjs-plugin-annotation']);
  </script>
  <script>
    // Registro de Service Worker para PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('✅ SW registrado:', reg.scope))
          .catch(err => console.error('❌ Error al registrar SW:', err));
      });
    }
  </script>
</body>
</html>
